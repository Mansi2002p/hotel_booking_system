@extends('web.layouts.app')

@section('title', ' - Hotel Details')

@section('content')
<div class="row">
    <div class="col-xl-4 col-lg-5 offset-xl-2 offset-lg-1" style="border:1px solid #ebebeb;">
        <br>
        <div class="col-lg-4 col-lg-12  p-3" style="border:1px solid #ebebeb; background: #fff;  border-radius: 10px;">
            <div id="room-details" class="mt-3">
                @if($selectedRoom)
                    <h4>Room Details</h4>
                    @if($selectedRoom->hasMedia('room_images'))
                        <img src="{{ $selectedRoom->getFirstMediaUrl('room_images', 'thumb') }}" alt="Room Image">
                    @else
                        <p>No image available for this room.</p>
                    @endif
                    <p><strong>Room Type:</strong> {{ $selectedRoom->roomType->name }}</p>
                    <p><strong>Bed:</strong> Max person {{ $selectedRoom->bed_capacity }}</p>
                    <p><strong>Air Conditon:</strong>  {{ $selectedRoom->air_conditon }}</p>
                    <p><strong>Price per Night:</strong> ₹{{ $selectedRoom->price }}</p>
                    <p><strong>Services:</strong> {{ $selectedRoom->amenities->pluck('name')->take(2)->implode(' , ') }} </p>
                @else
                    <p>Please select a room to see details.</p>
                @endif
            </div>
        </div>

        <div style="border:1px solid #ebebeb; background: #fff; border-radius: 10px; padding:10px ; margin-top:10px">
            <input type="hidden" id="room_id" name="room_id" value="{{ $rooms->first()->id }}">
            <h3>Price Details:</h3>
            <hr>
            <div class="summary-item d-flex justify-content-between">
                <span>Hotel Charges</span>
                <span id="hotel-charges">₹0</span>
            </div>
            <div class="summary-item d-flex justify-content-between text-success fw-semibold">
                <span>Discounts</span>
                <span id="discount">- ₹0</span>
            </div>
            <hr>
            <div class="summary-item d-flex justify-content-between fw-bold fs-5">
                <span>Sub Total</span>
                <span id="sub-total">₹0</span>
            </div>
            <div class="summary-item d-flex justify-content-between text-muted">
                <span>Taxes & Charges</span>
                <span id="taxes">₹0</span>
            </div>
            <div class="summary-item d-flex justify-content-between text-muted">
                <span>Service Charge</span>
                <span id="service-charge">₹569</span>
            </div>
            <hr>
            <div class="summary-item d-flex justify-content-between text-dark fw-bold fs-4">
                <span>You Pay</span>
                <span id="total-price">₹0</span>
            </div>
            <div class="summary-item d-flex justify-content-between text-success fw-semibold">
                <span>Total Saving</span>
                <span id="total-saving">₹0</span>
            </div>
        </div>
 <br>
    </div>

    <div class="col-lg-4 col-md-6 col-sm-12 p-3" style="border:1px solid #ebebeb; background: #fff; border-radius: 10px; margin-left:20px">

        <div class="booking-form">
            <h3>Booking Your Hotel</h3>
            <form action="{{ route('book.room') }}" method="POST" id="bookingForm">
                @csrf
                <div class="check-date">
                    <label for="checkin_date">Check In:</label>
                    <input type="date" id="checkin_date" name="checkin_date" >
                </div>
                <div class="check-date">
                    <label for="checkout_date">Check Out:</label>
                    <input type="date" id="checkout_date" name="checkout_date" >
                </div>
                <div class="check-date">
                    <label for="">Guest</label>
                    <input type="number" id="guests" name="guests" min="1" required>
                </div>

                <div class="select-option">
                    <label for="">Rooms</label>
                    <select name="rooms" id="rooms">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>

                <div class="select-option">
                    <label>Room Type :</label>
                        <select id="room_id" name="room_id">
                            @foreach($rooms as $room)
                 
                                <option value="{{ $room->id }}">{{ $room->roomType->name }}</option>
                            @endforeach
                        </select>
                </div>
                <button type="button" id="book-now-btn">Book Now</button>
            </form>
        </div>

    </div>
</div>
<br>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $.ajaxSetup({
        headers: {
            "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content")
        }
    });
    $(document).ready(function() {
    let firstRoom = @json($rooms->first());

    if (firstRoom) {
        $("#room-image").attr("src", firstRoom.image ? "{{ asset('storage/') }}/" + firstRoom.image : "").show();
        $("#selected-room-type").text(firstRoom.room_type.name); // Display room type
        $("#room-price").text(firstRoom.price);
        $("#room_id").val(firstRoom.id); // Store room ID in hidden input
    }
});

    function updatePrice() {
    let formData = {
        _token: "{{ csrf_token() }}",
        room_id: $("#room_id").val(),
        checkin_date: $("#checkin_date").val(),
        checkout_date: $("#checkout_date").val(),
        guests: $("#guests").val(),
        rooms: $("#rooms").val() // Pass the number of rooms
    };

    $.ajax({
        url: "{{ route('calculate.price') }}",
        type: "POST",
        data: formData,
        success: function(response) {
            if (response.error) {
                alert(response.error);
                return;
            }
            $("#hotel-charges").text(`₹${response.hotel_charges.toFixed(2)}`);
            $("#discount").text(`- ₹${response.discount.toFixed(2)}`);
            $("#sub-total").text(`₹${response.sub_total.toFixed(2)}`);
            $("#taxes").text(`₹${response.taxes.toFixed(2)}`);
            $("#total-price").text(`₹${response.total_price.toFixed(2)}`);
            $("#total-saving").text(`₹${response.discount.toFixed(2)}`);
        },
        error: function(xhr) {
            console.log(xhr.responseJSON);
        }
    });
}

// Bind event listener for room selection
$("#checkin_date, #checkout_date, #guests, #room_id, #rooms").on("change", updatePrice);


    $("#checkin_date, #checkout_date, #guests, #room_id").on("change", updatePrice);

    // ✅ Add Booking Functionality
    $("#book-now-btn").on("click", function() {
        let bookingData = {
            _token: "{{ csrf_token() }}",
            room_id: $("#room_id").val(),
            checkin_date: $("#checkin_date").val(),
            checkout_date: $("#checkout_date").val(),
            guests: $("#guests").val(),
            rooms: $("#rooms").val() // Pass the number of rooms
        };

        $.ajax({
            url: "{{ route('book.room') }}",
            type: "POST",
            data: bookingData,
            success: function(response) {
                alert("Booking Successful!");
                console.log(response);
                window.location.reload(); // Refresh page after booking
            },
            error: function(xhr) {
                console.log(xhr.responseJSON);
                alert("Booking failed! Please check the console for errors.");
            }
        });
    });
</script>

@endsection














<?php

namespace App\Http\Controllers\customer;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\Room;
use App\Models\Booking;
use App\Helpers\PriceHelper;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;

class BookingController extends Controller
{
    
    public function index(Request $request) {
        $rooms = Room::with(['hotel', 'roomType'])->get();
    
        // Check if room_id is provided in the URL
        $selectedRoom = null;
        if ($request->has('room_id')) {
            $selectedRoom = Room::with(['hotel', 'roomType'])->find($request->room_id);
        }
    
        return view('web.customer.booking', compact('rooms', 'selectedRoom'));
    }
    


    public function store(Request $request)
    {
        $validated = $request->validate([
            'room_id' => 'required|exists:rooms,id',
            'checkin_date' => 'required|date',
            'checkout_date' => 'required|date|after:checkin_date',
            'guests' => 'required|integer|min:1',
            'rooms' => 'required | integer | min:1' 
        ]);

        $prices = PriceHelper::calculateTotalPrice(
            $request->room_id,
            $request->checkin_date,
            $request->checkout_date,
            $request->guests,
            $request->rooms 
        );

        if (isset($prices['error'])) {
            return response()->json(['error' => $prices['error']], 400);
        }


        $booking = Booking::create([
            'user_id' => Auth::id(),
            'room_id' => $request->room_id,
           'check_in_date' => $request->checkin_date,
            'check_in_out' => $request->checkout_date,  // Ensure the request contains this field
            'guests' => $request->guests,
            'hotel_charges' => $prices['hotel_charges'],
            'discount' => $prices['discount'],
            'sub_total' => $prices['sub_total'],
            'taxes' => $prices['taxes'],
            'service_charge' => $prices['service_charge'],
            'total_price' => $prices['total_price'],
            'status' => $request->status ?? 'pending', 
            'rooms' => $request->rooms, // Store the number of rooms
        ]);


        return response()->json([
            'message' => 'Booking successful!',
            'booking' => $booking
        ]);
    }

    public function calculatePrice(Request $request)
{
    $data = PriceHelper::calculateTotalPrice(
        $request->room_id,
        $request->checkin_date,
        $request->checkout_date,
        $request->guests,
        $request->rooms // Add rooms here
    );

    return response()->json($data);
}

    
}












//booking
Route::get('/bookings', [HotelBookingController::class, 'index'])->name('bookings.index');
Route::get('/bookings/data', [HotelBookingController::class, 'getBookings'])->name('bookings.data');
Route::get('/bookings/details', [HotelBookingController::class, 'bookingDetails'])->name('bookings.details');




















// rooms.blade.php 




@extends('web.layouts.app')

@section('title', 'Rooms')

@section('content')
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<!-- Rooms Section Begin -->
<section class="rooms-section spad">
    <div class="container">
        <div class="row">
            @forelse($rooms as $room)  <!-- Loop through rooms dynamically -->
                <div class="col-lg-4 col-md-6">
                    <div class="room-item">
                        <img src="{{ $room->image ?: asset('img/default-room.jpg') }}" alt="">
                        <div class="ri-text">
                            <h4>{{ $room->roomType->name ?? 'Unknown Type' }}</h4>
                            <h3>{{ $room->price }}<span> /Per night</span></h3>
                            <table>
                                <tbody>
                                    <tr>
                                        <td class="r-o">Size:</td>
                                        <td>30 ft</td>
                                    </tr>
                                    <tr>
                                        <td class="r-o">Capacity:</td>
                                        <td>Max person {{ $room->bed_capacity }}</td>
                                    </tr>
                                    <tr>
                                        <td class="r-o">Bed:</td>
                                        <td>{{ $room->bed_capacity > 1 ? 'Multiple Beds' : 'Single Bed' }}</td>
                                    </tr>
                                    <tr>
                                        <td class="r-o">Air Conditon:</td>
                                        <td>{{ $room->air_conditon}}</td>
                                    </tr>
                                    <tr>
                                        <td class="r-o">Amenities:</td>
                                        <td>
                                            {{ $room->amenities->pluck('name')->take(2)->implode(', ') }} 
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <a href="{{ route('rooms.show', $room->id) }}" class="primary-btn" style="text-decoration: none">More Details</a>
                            <br>
                            @if(auth()->check())
                            <!-- If user is logged in, go to booking page -->
                            <a href="{{ route('customer.booking', ['room_id' => $room->id]) }}" class="btn mt-5" style="background-color: #dfa974; color: #fff;  margin-left:130px">
                                Book Now
                            </a>
                            
                        @else
                            <!-- If user is NOT logged in, redirect to login page with intended URL -->
                            <a href="{{ route('login', ['redirect' => route('rooms.show', $room->id)]) }}" class="btn mt-5" style="background-color: #dfa974; color: #fff;  margin-left:130px ">
                                Book Now
                            </a>
                        @endif
                        </div>
                    </div>
                </div>
            @empty
                <div class="col-lg-12">
                    <p class="text-center">No rooms available.</p>
                </div>
            @endforelse
        </div>

        <!-- Pagination -->
        <div class="col-lg-12 d-flex justify-content-center">
            <div class="room-pagination">
                {{ $rooms->links('pagination::bootstrap-4') }}  <!-- Use Bootstrap pagination -->
            </div>
        </div>
        
    </div>
</section>
<!-- Rooms Section End -->
@endsection